name: Deploy Ring 1

on:
  push:
    tags:
      - ring1.*
jobs:
    pre-ring1:
      runs-on: ubuntu-latest
      timeout-minutes: 15
      steps:
        - name: 'Block Concurrent Executions'
          uses: softprops/turnstyle@v1
          with:
            poll-interval-seconds: 10
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    Ring1:
      needs: pre-ring1
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2
        with:
          path: spms
      - uses: actions/checkout@v2
        name: Checkut getspms-hosting
        with:
          repository: ITHedgeHog/getspms-hosting
          ref: main
          token:  ${{ secrets.PAC }}
          path: hosting
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save spms-cluster
      - name: Update deployment file image
        run: TAG=$(echo $GITHUB_SHA | head -c7) && sed -i 's|<IMAGE>|registry.digitalocean.com/agile-h/spms:'${TAG}'|' $GITHUB_WORKSPACE/hosting/config/deployment1/deployment.yml
      - name: Update deployment file COMMIT_BRANCH
        run: BRANCH=$(echo $GITHUB_REF) && sed -i 's|<COMMIT_BRANCH>|'${BRANCH}'|' $GITHUB_WORKSPACE/hosting/config/deployment1/deployment.yml
      - name: Update deployment file COMMIT_SHA
        run: TAG=$(echo $GITHUB_SHA) && sed -i 's|<COMMIT_SHA>|'${TAG}'|' $GITHUB_WORKSPACE/hosting/config/deployment1/deployment.yml
      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save spms-cluster
      - name: Deploy to DigitalOcean Kubernetes
        run: kubectl apply -f $GITHUB_WORKSPACE/hosting/config/deployment1/deployment.yml
      - name: Configure Ingresses
        run: kubectl apply -f $GITHUB_WORKSPACE/hosting/config/deployment1/sites/spms.yml
      - name: Verify deployment
        run: kubectl rollout status deployment/spms-1
